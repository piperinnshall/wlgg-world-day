extends Node2D

# Set this to true before the game to add levels
const in_editor: bool = false

var level_name_current = "WHIMSICAL_TOWN"

# How long it takes for the key to reach the critical spot
var km_move_time: float = 1.625
var km_output_arr = [[], []]

# Each level has an array km_times
# km times stores the time to spawn the km
var level_info = {
	"WHIMSICAL_TOWN" = {
		"km_times": "[[4.15892202301025, 6.16416055603027, 8.15871793670654, 10.1746137802124, 12.1478336517334, 12.6384685699463, 15.1130035583496, 16.1582878295898, 16.6489227478027, 19.1447952453613, 20.1260879699707, 20.6593750183105, 23.1339100067139, 24.1791942779541, 24.6591709320068, 26.6644104187012, 29.1282661621094, 30.1948860351563, 30.6641815368652, 32.1574485961914, 32.6160896484375, 32.9787414733887, 35.122616595459, 37.149170703125, 38.1731155578613, 38.6424377624512, 40.1996696655273, 40.6476524536133, 40.9996460144043, 42.6315544311523, 44.6474464599609, 45.6074035827637, 46.674000567627, 48.1459282104492, 48.4979026977539, 49.1485374633789, 49.5111892883301, 50.1618240539551, 51.1750915710449, 52.6256797973633, 53.6389663879395, 54.6735695068359, 56.1454971496582, 56.4974716369629, 57.1587875549316, 57.532097644043, 58.1613929931641, 59.1746833984375, 64.1450660888672, 68.155518359375, 70.10742265625, 70.6300590698242, 70.9713676635742, 72.144661730957, 72.6779487792969, 72.9979484741211, 74.1392143432617, 74.6725013916016, 74.9925087158203, 76.1230934326172, 77.1257255737305], [5.1615522567749, 7.17742521209717, 9.18266374511719, 11.1772211257935, 13.1824596588135, 14.1743877593994, 14.6757019226074, 17.1608951751709, 18.1741836730957, 18.6968124572754, 21.1606910888672, 22.173979586792, 22.6752708618164, 25.1924827758789, 26.1737526123047, 27.197697467041, 28.1789901916504, 28.6802833740234, 29.0002830688477, 31.1654976074219, 33.1493995849609, 34.2266548339844, 34.6746376220703, 36.2318924133301, 36.679875201416, 36.9998520080566, 39.1437309448242, 41.1596267883301, 42.1729133789063, 43.1755226318359, 44.1781280700684, 44.4767921630859, 45.1594207946777, 45.4580619995117, 46.1940239135742, 47.1966331665039, 48.6472213928223, 49.6605079833984, 50.6418007080078, 52.1563842956543, 52.4657028381348, 53.1589897338867, 53.4789665405273, 54.1722763244629, 55.2068832580566, 56.6788070861816, 57.6814163391113, 58.6627090637207, 63.6971061889648, 64.6783760253906, 67.6755455200195, 68.6568382446289, 69.6594474975586, 69.9794243041992, 71.1420295898437, 71.6753395263672, 71.9953163330078, 73.1579216186523, 73.6698997680664, 73.957878894043, 75.1418235961914, 75.6644523803711, 76.6777427856445, 77.1470421020508]]",
		#"km_times": "[[1],[]]",
		"music": load("res://assets/music/Mechanical Town.wav")
	}
}
func _ready() -> void:
	$MusicPlayer.stream = level_info.get(level_name_current).get("music")
	$MusicPlayer.play()
	
	if in_editor:
		Signals.key_listener_press.connect(key_listener_press)
	else:
		var km_times = level_info.get(level_name_current).get("km_times")
		var km_times_arr = str_to_var(km_times)
		
		var counter: int = 0
		
		for key in km_times_arr:
			
			var button_name: String = ""
			match counter:
				0: 
					button_name = "key_Q"
				1:
					button_name = "key_E"
			
			for delay in key:
				spawn_moving_key(button_name, delay)
		
			counter += 1

func key_listener_press(button_name: String, array_num: int):
	km_output_arr[array_num].append($MusicPlayer.get_playback_position()- km_move_time)

func spawn_moving_key(button_name: String, delay: float):
	await get_tree().create_timer(delay).timeout
	Signals.create_moving_key.emit(button_name)

func _on_music_player_finished() -> void:
	get_tree().change_scene_to_file("res://src/stages/end_menu.tscn")
